name: CI

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]

  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2025
    steps:
      - uses: actions/checkout@v4

      - name: chceck wsl version
        run: wsl --version

      - name: install wsl ubuntu
        run: wsl --install Ubuntu-24.04

      - name: install docker
        run: | 
          wsl -- sudo apt-get update
          wsl -- sudo apt-get install dos2unix
          wsl -- dos2unix ./docker-install.sh
          wsl -- ./docker-install.sh

      - name: run hello world
        run: wsl -- sudo docker run hello-world
   
      - name: compose up
        run: wsl -- sudo docker compose -p test-setup up -d

      - name: curl (wsl)
        run: wsl -- curl http://localhost:8080

      - name: web-request (windows)
        run: Invoke-WebRequest -Uri http://localhost:8080

      - name: docker ps (wsl)
        run: wsl -- sudo docker ps

      - name: docker ps (windows)
        run: docker ps

      # - name: run db server
      #   run: wsl -- sudo docker run -e "ACCEPT_EULA=Y" -e "MSSQL_SA_PASSWORD=SecretPass94" -p 1433:1433 --name sql1 --hostname sql1 -d mcr.microsoft.com/mssql/server:2022-latest
      
      - name: wait on db (windows)
        run: |
          $miliSeconds = 60*1000;
          $task = [System.Threading.Tasks.Task]::Delay($miliSeconds)
          $task.Wait()

      - name: compose logs
        run: wsl -- sudo docker compose -p test-setup logs

      # - name: logs from db server
      #   run: wsl -- sudo docker logs sql1

      - name: wsl host name
        run: wsl hostname -I

      - name: install sqlcmd
        run: |
          choco install sqlcmd-tools -y
          refreshenv

      - name: verify sqlcmd
        run: sqlcmd -?

      - name: verify sqlcmd
        run: |
          sqlcmd `
          -S localhost,1433 `
          -U sa `
          -P "SecretPassword9!" `
          -Q "SELECT name FROM sys.databases" `
          -N



        






        
